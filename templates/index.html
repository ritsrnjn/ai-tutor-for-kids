<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nani - Your Hindi Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); */
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Platform Selector */
        .platform-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .platform-selector h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #333;
            text-align: center;
        }

        .platform-options {
            display: flex;
            gap: 10px;
        }

        .platform-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .platform-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .platform-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .platform-btn.elevenlabs {
            border-color: #4facfe;
        }

        .platform-btn.elevenlabs.active {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .platform-btn.livekit {
            border-color: #4caf50;
        }

        .platform-btn.livekit.active {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
        }

        .main-container {
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: space-between;
            padding: 2rem;
            gap: 2rem;
        }

        /* Left Side - ElevenLabs ConvAI Widget */
        .left-widget {
            flex: 1;
            max-width: 450px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 1rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 500px;
        }

        /* Style the ElevenLabs widget container */
        elevenlabs-convai {
            width: 100%;
            height: 100%;
            min-height: 400px;
            border-radius: 20px;
            overflow: hidden;
        }

        /* LiveKit Voice Interface Styles */
        .livekit-voice-interface {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 2rem;
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .voice-trigger-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
        }

        .voice-trigger-button {
            position: relative;
            width: 280px;
            height: 280px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            user-select: none;
        }

        .voice-trigger-button:hover {
            transform: scale(1.05);
        }

        .voice-trigger-button.active {
            background: radial-gradient(circle, rgba(255, 107, 107, 0.5) 0%, rgba(79, 172, 254, 0.3) 50%, transparent 70%);
        }

        .voice-trigger-button.listening {
            animation: listening-pulse 2s ease-in-out infinite;
        }

        .voice-trigger-button.processing {
            animation: processing-spin 1.5s linear infinite;
        }

        .pulse-ring {
            position: absolute;
            border: 3px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            width: 100%;
            height: 100%;
            animation: pulse-ring 2s cubic-bezier(0.25, 0, 0, 1) infinite;
        }

        .pulse-ring-2 {
            animation-delay: 0.5s;
            border-color: rgba(255, 255, 255, 0.4);
        }

        .pulse-ring-3 {
            animation-delay: 1s;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .trigger-core {
            position: relative;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow:
                0 0 30px rgba(255, 255, 255, 0.3),
                inset 0 0 30px rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            color: #667eea;
        }

        .voice-trigger-button:hover .trigger-core {
            box-shadow:
                0 0 50px rgba(255, 255, 255, 0.5),
                inset 0 0 30px rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
        }

        .voice-trigger-button.active .trigger-core {
            background: linear-gradient(135deg, #ff6b6b, #4facfe);
            color: white;
            box-shadow:
                0 0 60px rgba(255, 107, 107, 0.8),
                inset 0 0 30px rgba(255, 255, 255, 0.3);
        }

        .voice-trigger-button.processing .trigger-core {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            box-shadow:
                0 0 60px rgba(240, 147, 251, 0.8),
                inset 0 0 30px rgba(255, 255, 255, 0.3);
        }

        .trigger-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .voice-trigger-button.active .trigger-icon {
            animation: bounce 0.6s ease infinite alternate;
        }

        .trigger-text {
            font-size: 1.1rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 0.2rem;
        }

        .trigger-subtitle {
            font-size: 0.9rem;
            font-weight: 400;
            opacity: 0.8;
        }

        .voice-visualizer {
            position: absolute;
            bottom: 20px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .voice-trigger-button.listening .voice-visualizer {
            opacity: 1;
        }

        .visualizer-bar {
            width: 3px;
            height: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2px;
            animation: visualizer 1.5s ease-in-out infinite;
        }

        .visualizer-bar:nth-child(2) { animation-delay: 0.1s; }
        .visualizer-bar:nth-child(3) { animation-delay: 0.2s; }
        .visualizer-bar:nth-child(4) { animation-delay: 0.3s; }
        .visualizer-bar:nth-child(5) { animation-delay: 0.4s; }

        .voice-status {
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-top: 1rem;
        }

        .platform-info {
            margin-top: 2rem;
            text-align: center;
        }

        .platform-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .platform-description {
            font-size: 0.9rem;
            opacity: 0.8;
            margin: 0;
        }

        /* Animations */
        @keyframes listening-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes processing-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes visualizer {
            0%, 100% { height: 20px; }
            50% { height: 40px; }
        }

        /* Voice Trigger Button Styles */
        .voice-trigger-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
        }

        .voice-trigger-button {
            position: relative;
            width: 280px;
            height: 280px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(139, 69, 192, 0.3) 0%, rgba(79, 172, 254, 0.2) 50%, transparent 70%);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            user-select: none;
        }

        .voice-trigger-button:hover {
            transform: scale(1.05);
        }

        .voice-trigger-button.active {
            background: radial-gradient(circle, rgba(139, 69, 192, 0.5) 0%, rgba(79, 172, 254, 0.3) 50%, transparent 70%);
        }

        .pulse-ring {
            position: absolute;
            border: 3px solid rgba(139, 69, 192, 0.8);
            border-radius: 50%;
            width: 100%;
            height: 100%;
            animation: pulse-ring 2s cubic-bezier(0.25, 0, 0, 1) infinite;
        }

        .pulse-ring-2 {
            animation-delay: 0.5s;
            border-color: rgba(79, 172, 254, 0.6);
        }

        .pulse-ring-3 {
            animation-delay: 1s;
            border-color: rgba(168, 85, 247, 0.4);
        }

        .trigger-core {
            position: relative;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b45c0, #4facfe);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow:
                0 0 30px rgba(139, 69, 192, 0.5),
                inset 0 0 30px rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .voice-trigger-button:hover .trigger-core {
            box-shadow:
                0 0 50px rgba(139, 69, 192, 0.8),
                inset 0 0 30px rgba(255, 255, 255, 0.2);
        }

                .voice-trigger-button.active .trigger-core {
            background: linear-gradient(135deg, #ff6b6b, #4facfe);
            box-shadow:
                0 0 60px rgba(255, 107, 107, 0.8),
                inset 0 0 30px rgba(255, 255, 255, 0.3);
        }

        .voice-trigger-button.processing .trigger-core {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            box-shadow:
                0 0 60px rgba(240, 147, 251, 0.8),
                inset 0 0 30px rgba(255, 255, 255, 0.3);
            animation: processing-pulse 1.5s ease-in-out infinite;
        }

        .voice-trigger-button.speaking .trigger-core {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            box-shadow:
                0 0 60px rgba(79, 172, 254, 0.8),
                inset 0 0 30px rgba(255, 255, 255, 0.3);
            animation: speaking-glow 2s ease-in-out infinite;
        }

        .trigger-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .voice-trigger-button.active .trigger-icon {
            animation: bounce 0.6s ease infinite alternate;
        }

        .trigger-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .voice-visualizer {
            position: absolute;
            bottom: 20px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .voice-trigger-button.listening .voice-visualizer {
            opacity: 1;
        }

        .visualizer-bar {
            width: 3px;
            height: 20px;
            background: linear-gradient(to top, #4facfe, #8b45c0);
            border-radius: 2px;
            animation: visualizer 0.6s ease-in-out infinite alternate;
        }

        .visualizer-bar:nth-child(2) { animation-delay: 0.1s; }
        .visualizer-bar:nth-child(3) { animation-delay: 0.2s; }
        .visualizer-bar:nth-child(4) { animation-delay: 0.3s; }
        .visualizer-bar:nth-child(5) { animation-delay: 0.4s; }

        .voice-status {
            font-size: 1.2rem;
            color: #333;
            text-align: center;
            font-weight: 500;
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        /* Animations */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            80%, 100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        @keyframes visualizer {
            from { height: 10px; }
            to { height: 30px; }
        }

        @keyframes processing-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes speaking-glow {
            0%, 100% {
                box-shadow:
                    0 0 60px rgba(79, 172, 254, 0.8),
                    inset 0 0 30px rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow:
                    0 0 80px rgba(79, 172, 254, 1),
                    inset 0 0 40px rgba(255, 255, 255, 0.4);
            }
        }

        /* Right Side - Better alignment */
        .right-side {
            flex: 1;
            max-width: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 500px;
            padding: 1rem;
        }

        /* Connection status - Move to bottom left */
        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            z-index: 999;
            transition: all 0.3s ease;
            animation: slideInFromLeft 0.3s ease;
        }

        /* Animations */

        @keyframes slideInFromLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile responsiveness */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                padding: 1rem;
                gap: 1rem;
            }

            .left-widget {
                max-width: 100%;
                min-height: 300px;
            }

            .right-side {
                max-width: 100%;
                min-height: 400px;
            }

            /* Voice trigger responsive adjustments */
            .voice-trigger-button {
                width: 220px;
                height: 220px;
            }

            .trigger-core {
                width: 160px;
                height: 160px;
            }

            .trigger-icon {
                font-size: 2.5rem;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 0.5rem;
            }

            .left-widget {
                padding: 1.5rem;
                min-height: 250px;
            }

            .voice-trigger-button {
                width: 180px;
                height: 180px;
            }

            .trigger-core {
                width: 130px;
                height: 130px;
            }

            .trigger-icon {
                font-size: 2rem;
            }

            .trigger-text {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Left Side - Platform-specific Widget -->
        <div class="left-widget">
            {% if platform == 'elevenlabs' %}
                <!-- ElevenLabs ConvAI Embed with Dynamic Variables Support -->
                <elevenlabs-convai
                    agent-id="agent_01jy9sz4gnew0vedv885xsrse1"
                    id="elevenlabs-widget"
                    dynamic-variables='{"learning_topic": "animals", "session_type": "hindi_learning"}'>
                </elevenlabs-convai>
                        {% else %}
                <!-- LiveKit Voice Interface -->
                <div class="livekit-voice-interface">
                    <!-- Voice Trigger Button -->
                    <div class="voice-trigger-container">
                        <div class="voice-trigger-button" id="livekitVoiceTrigger">
                            <div class="pulse-ring"></div>
                            <div class="pulse-ring pulse-ring-2"></div>
                            <div class="pulse-ring pulse-ring-3"></div>
                            <div class="trigger-core">
                                <div class="trigger-icon">üé§</div>
                                <div class="trigger-text">Tap to Talk</div>
                                <div class="trigger-subtitle">‡§®‡§æ‡§®‡•Ä ‡§∏‡•á ‡§¨‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç</div>
                            </div>
                            <div class="voice-visualizer">
                                <div class="visualizer-bar"></div>
                                <div class="visualizer-bar"></div>
                                <div class="visualizer-bar"></div>
                                <div class="visualizer-bar"></div>
                                <div class="visualizer-bar"></div>
                            </div>
                        </div>
                        <div class="voice-status" id="livekitVoiceStatus">Ready to chat with Nani in Hindi</div>
                    </div>

                    <!-- Platform Info -->
                    <div class="platform-info">
                        <div class="platform-badge">{{ platform_name }}</div>
                        <p class="platform-description">Hindi Voice Assistant powered by Sarvam AI</p>

                        <!-- Debug Test Button -->
                        <button id="testLivekitBtn" style="margin-top: 1rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); border: none; border-radius: 10px; color: white; cursor: pointer;">
                            Test LiveKit (Debug)
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Right Side - Space for Image Widget -->
        <div class="right-side">
            <!-- Image display component will appear here -->
        </div>
    </div>

    <!-- Connection Status Badge (moved to bottom left) -->
    <div class="connection-status" id="connectionBadge">üîÑ Connecting...</div>

    <!-- ElevenLabs ConvAI Widget (only load for ElevenLabs platform) -->
    {% if platform == 'elevenlabs' %}
    <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>
    {% endif %}

    <!-- Socket.IO Client Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <!-- Image Display Component -->
    <script src="{{ url_for('static', filename='js/image_display_component.js') }}"></script>

    <script>
        // WebSocket and audio streaming variables
        let socket;
        let isConnected = false;
        let connectionBadge;

        // LiveKit-specific variables
        let livekitVoiceTrigger;
        let livekitVoiceStatus;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let currentState = 'idle'; // idle, listening, processing, speaking
        let platform = '{{ platform }}';

        // Function to update ElevenLabs widget dynamic variables
        function updateElevenLabsDynamicVariables(topic) {
            if (platform === 'elevenlabs') {
                const widget = document.getElementById('elevenlabs-widget');
                if (widget) {
                    const dynamicVars = {
                        "learning_topic": topic || "general",
                        "session_type": "hindi_learning"
                    };
                    widget.setAttribute('dynamic-variables', JSON.stringify(dynamicVars));
                    console.log('üìù Updated ElevenLabs dynamic variables:', dynamicVars);
                }
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing AI Tutor with platform:', platform);

            // Initialize DOM elements
            connectionBadge = document.getElementById('connectionBadge');

                        if (platform === 'livekit') {
                livekitVoiceTrigger = document.getElementById('livekitVoiceTrigger');
                livekitVoiceStatus = document.getElementById('livekitVoiceStatus');

                // Setup LiveKit voice interface
                setupLivekitVoiceInterface();
                initializeAudioRecording();

                // Setup debug test button
                const testBtn = document.getElementById('testLivekitBtn');
                if (testBtn) {
                    testBtn.addEventListener('click', () => {
                        console.log('üß™ Testing LiveKit endpoint...');
                        updateLivekitVoiceStatus('Testing LiveKit connection...');

                        fetch('/livekit_voice', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ audio: 'test_data' })
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('‚úÖ Test response:', data);
                            updateLivekitVoiceStatus('Test successful: ' + data.response);

                            // Emit for image generation
                            if (socket && isConnected) {
                                socket.emit('agent_response', { response: data.response });
                            }
                        })
                        .catch(error => {
                            console.error('‚ùå Test failed:', error);
                            updateLivekitVoiceStatus('Test failed: ' + error.message);
                        });
                    });
                }
            }

            // Setup WebSocket connection
            initializeWebSocket();

            console.log('üìã Initialization complete');
        });

        function updateConnectionStatus(status) {
            if (!connectionBadge) return;

            switch(status) {
                case 'connected':
                    connectionBadge.textContent = 'üü¢ Connected';
                    connectionBadge.style.background = 'linear-gradient(135deg, #4caf50, #8bc34a)';
                    break;
                case 'disconnected':
                    connectionBadge.textContent = 'üî¥ Disconnected';
                    connectionBadge.style.background = 'linear-gradient(135deg, #f44336, #ff7043)';
                    break;
                default:
                    connectionBadge.textContent = 'üîÑ Connecting...';
                    connectionBadge.style.background = 'linear-gradient(135deg, #ff9800, #ffc107)';
            }
        }

        function initializeWebSocket() {
            console.log('üîå Connecting to WebSocket server...');
            socket = io();

            // Connection events
            socket.on('connect', () => {
                console.log('‚úÖ Connected to server');
                isConnected = true;
                updateConnectionStatus('connected');
            });

            socket.on('disconnect', () => {
                console.log('‚ùå Disconnected from server');
                isConnected = false;
                updateConnectionStatus('disconnected');
            });

            socket.on('reconnect', () => {
                console.log('üîÑ Reconnected to server');
                updateConnectionStatus('connected');
            });

            // Listen for agent responses to generate images
            socket.on('agent_response', (data) => {
                console.log('ü§ñ Agent response:', data.response);

                // Generate image for AI response
                fetch('/create_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ response: data.response })
                })
                .then(response => response.json())
                .then(imageData => {
                    console.log('üñºÔ∏è Image generated:', imageData.image_url);
                    if (window.imageDisplayComponent) {
                        window.imageDisplayComponent.displayImageForResponse(imageData, imageData.image_url);
                    }
                })
                .catch(error => {
                    console.error('Error generating image:', error);
                });
            });

            // Listen for topic updates from backend
            socket.on('topic_updated', (data) => {
                console.log('üìö Topic updated:', data.topic);
                updateElevenLabsDynamicVariables(data.topic);
            });

                        socket.on('error', (data) => {
                console.error('‚ùå Socket error:', data);
            });
        }

        // LiveKit Voice Interface Functions
        function setupLivekitVoiceInterface() {
            if (!livekitVoiceTrigger) return;

            // Click/Touch event for voice trigger
            livekitVoiceTrigger.addEventListener('click', handleLivekitVoiceTrigger);
            livekitVoiceTrigger.addEventListener('touchstart', handleLivekitVoiceTrigger);

            // Prevent default touch behaviors
            livekitVoiceTrigger.addEventListener('touchstart', (e) => e.preventDefault());
            livekitVoiceTrigger.addEventListener('touchend', (e) => e.preventDefault());

            console.log('üé§ LiveKit voice trigger initialized');
        }

        function handleLivekitVoiceTrigger() {
            console.log('üé§ Voice trigger clicked, current state:', currentState);
            if (currentState === 'idle') {
                startLivekitListening();
            } else if (currentState === 'listening') {
                stopLivekitListening();
            }
        }

        function startLivekitListening() {
            if (!mediaRecorder || mediaRecorder.state !== 'inactive') return;

            currentState = 'listening';
            isRecording = true;

            // Update UI
            livekitVoiceTrigger.classList.add('active', 'listening');
            updateLivekitVoiceStatus('‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç... ‡§¨‡•ã‡§≤‡§ø‡§è! (Listening... Speak now!)');

            // Start recording
            try {
                audioChunks = [];
                mediaRecorder.start();
                console.log('üé§ Started listening for LiveKit');
            } catch (error) {
                console.error('Error starting recording:', error);
                stopLivekitListening();
            }
        }

        function stopLivekitListening() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') return;

            currentState = 'processing';
            isRecording = false;

            // Update UI
            livekitVoiceTrigger.classList.remove('listening');
            livekitVoiceTrigger.classList.add('processing');
            updateLivekitVoiceStatus('‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç (Processing... Please wait)');

            // Stop recording
            try {
                mediaRecorder.stop();
                console.log('üõë Stopped listening for LiveKit');
            } catch (error) {
                console.error('Error stopping recording:', error);
            }
        }

        function updateLivekitVoiceStatus(message) {
            console.log('üîÑ Status update:', message);
            if (livekitVoiceStatus) {
                livekitVoiceStatus.textContent = message;
            }
        }

        function setLivekitVoiceTriggerState(state, message) {
            currentState = state;

            // Reset all classes
            livekitVoiceTrigger.classList.remove('active', 'listening', 'processing', 'speaking');

            switch(state) {
                case 'idle':
                    updateLivekitVoiceStatus(message || 'Ready to chat with Nani in Hindi');
                    break;
                case 'listening':
                    livekitVoiceTrigger.classList.add('active', 'listening');
                    updateLivekitVoiceStatus(message || '‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç... ‡§¨‡•ã‡§≤‡§ø‡§è! (Listening... Speak now!)');
                    break;
                case 'processing':
                    livekitVoiceTrigger.classList.add('active', 'processing');
                    updateLivekitVoiceStatus(message || '‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó... (Processing...)');
                    break;
                case 'speaking':
                    livekitVoiceTrigger.classList.add('active', 'speaking');
                    updateLivekitVoiceStatus(message || '‡§®‡§æ‡§®‡•Ä ‡§¨‡•ã‡§≤ ‡§∞‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç... (Nani is speaking...)');
                    break;
            }
        }

        function initializeAudioRecording() {
            console.log('üéôÔ∏è Initializing audio recording for LiveKit...');

            // Request microphone permission
            navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    sampleRate: 16000
                }
            })
            .then(stream => {
                // Initialize MediaRecorder
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                // Handle data available
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                // Handle recording stop
                mediaRecorder.onstop = () => {
                    console.log('üé§ Recording stopped for LiveKit');

                    // Create audio blob and send to server
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
                    const reader = new FileReader();

                    reader.onloadend = () => {
                        const base64Audio = reader.result.split(',')[1];
                        sendAudioToLivekit(base64Audio);
                    };

                    reader.readAsDataURL(audioBlob);
                    audioChunks = [];
                };

                updateLivekitVoiceStatus('üé§ Microphone ready! Tap to start talking with Nani');
                console.log('‚úÖ LiveKit audio recording initialized');

                // Test if the voice trigger button is properly set up
                if (livekitVoiceTrigger) {
                    console.log('‚úÖ Voice trigger button found and ready');
                } else {
                    console.error('‚ùå Voice trigger button not found');
                }
            })
            .catch(err => {
                updateLivekitVoiceStatus('‚ùå Microphone access needed. Please allow microphone access.');
                console.error('Error accessing microphone:', err);
            });
        }

                function sendAudioToLivekit(base64Audio) {
            console.log('üì§ Sending audio to LiveKit processing...');

            // Send audio to server for processing
            fetch('/livekit_voice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    audio: base64Audio
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ LiveKit response:', data.response);

                    // Emit agent response for image generation
                    if (socket && isConnected) {
                        socket.emit('agent_response', { response: data.response });
                    }

                    setLivekitVoiceTriggerState('speaking', '‡§®‡§æ‡§®‡•Ä ‡§¨‡•ã‡§≤ ‡§∞‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç... (Nani is speaking...)');

                    // Return to idle after "speaking"
                    setTimeout(() => {
                        setLivekitVoiceTriggerState('idle', 'Ready to chat with Nani in Hindi');
                    }, 3000);
                } else {
                    console.error('‚ùå LiveKit error:', data.error);
                    setLivekitVoiceTriggerState('idle', 'Error processing voice. Try again.');
                }
            })
            .catch(error => {
                console.error('‚ùå Network error:', error);
                setLivekitVoiceTriggerState('idle', 'Network error. Try again.');
            });
        }


    </script>
</body>
</html>
