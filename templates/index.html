<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nani - Your Hindi Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); */
            min-height: 100vh;
            overflow-x: hidden;
        }

        .main-container {
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: space-between;
            padding: 2rem;
            gap: 2rem;
        }

        /* Left Side - ElevenLabs ConvAI Widget */
        .left-widget {
            flex: 1;
            max-width: 450px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 1rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 500px;
        }

        /* Voice Trigger Button Styles */
        .voice-trigger-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
        }

        .voice-trigger-button {
            position: relative;
            width: 280px;
            height: 280px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(139, 69, 192, 0.3) 0%, rgba(79, 172, 254, 0.2) 50%, transparent 70%);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            user-select: none;
        }

        .voice-trigger-button:hover {
            transform: scale(1.05);
        }

        .voice-trigger-button.active {
            background: radial-gradient(circle, rgba(139, 69, 192, 0.5) 0%, rgba(79, 172, 254, 0.3) 50%, transparent 70%);
        }

        .pulse-ring {
            position: absolute;
            border: 3px solid rgba(139, 69, 192, 0.8);
            border-radius: 50%;
            width: 100%;
            height: 100%;
            animation: pulse-ring 2s cubic-bezier(0.25, 0, 0, 1) infinite;
        }

        .pulse-ring-2 {
            animation-delay: 0.5s;
            border-color: rgba(79, 172, 254, 0.6);
        }

        .pulse-ring-3 {
            animation-delay: 1s;
            border-color: rgba(168, 85, 247, 0.4);
        }

        .trigger-core {
            position: relative;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b45c0, #4facfe);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow:
                0 0 30px rgba(139, 69, 192, 0.5),
                inset 0 0 30px rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .voice-trigger-button:hover .trigger-core {
            box-shadow:
                0 0 50px rgba(139, 69, 192, 0.8),
                inset 0 0 30px rgba(255, 255, 255, 0.2);
        }

                .voice-trigger-button.active .trigger-core {
            background: linear-gradient(135deg, #ff6b6b, #4facfe);
            box-shadow:
                0 0 60px rgba(255, 107, 107, 0.8),
                inset 0 0 30px rgba(255, 255, 255, 0.3);
        }

        .voice-trigger-button.processing .trigger-core {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            box-shadow:
                0 0 60px rgba(240, 147, 251, 0.8),
                inset 0 0 30px rgba(255, 255, 255, 0.3);
            animation: processing-pulse 1.5s ease-in-out infinite;
        }

        .voice-trigger-button.speaking .trigger-core {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            box-shadow:
                0 0 60px rgba(79, 172, 254, 0.8),
                inset 0 0 30px rgba(255, 255, 255, 0.3);
            animation: speaking-glow 2s ease-in-out infinite;
        }

        .trigger-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .voice-trigger-button.active .trigger-icon {
            animation: bounce 0.6s ease infinite alternate;
        }

        .trigger-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .voice-visualizer {
            position: absolute;
            bottom: 20px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .voice-trigger-button.listening .voice-visualizer {
            opacity: 1;
        }

        .visualizer-bar {
            width: 3px;
            height: 20px;
            background: linear-gradient(to top, #4facfe, #8b45c0);
            border-radius: 2px;
            animation: visualizer 0.6s ease-in-out infinite alternate;
        }

        .visualizer-bar:nth-child(2) { animation-delay: 0.1s; }
        .visualizer-bar:nth-child(3) { animation-delay: 0.2s; }
        .visualizer-bar:nth-child(4) { animation-delay: 0.3s; }
        .visualizer-bar:nth-child(5) { animation-delay: 0.4s; }

        .voice-status {
            font-size: 1.2rem;
            color: #333;
            text-align: center;
            font-weight: 500;
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        /* Animations */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            80%, 100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        @keyframes visualizer {
            from { height: 10px; }
            to { height: 30px; }
        }

        @keyframes processing-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes speaking-glow {
            0%, 100% {
                box-shadow:
                    0 0 60px rgba(79, 172, 254, 0.8),
                    inset 0 0 30px rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow:
                    0 0 80px rgba(79, 172, 254, 1),
                    inset 0 0 40px rgba(255, 255, 255, 0.4);
            }
        }

        /* Right Side - Better alignment */
        .right-side {
            flex: 1;
            max-width: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 500px;
            padding: 1rem;
        }

        /* Connection status - Move to bottom left */
        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            z-index: 999;
            transition: all 0.3s ease;
            animation: slideInFromLeft 0.3s ease;
        }

        /* Animations */

        @keyframes slideInFromLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile responsiveness */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                padding: 1rem;
                gap: 1rem;
            }

            .left-widget {
                max-width: 100%;
                min-height: 300px;
            }

            .right-side {
                max-width: 100%;
                min-height: 400px;
            }

            /* Voice trigger responsive adjustments */
            .voice-trigger-button {
                width: 220px;
                height: 220px;
            }

            .trigger-core {
                width: 160px;
                height: 160px;
            }

            .trigger-icon {
                font-size: 2.5rem;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 0.5rem;
            }

            .left-widget {
                padding: 1.5rem;
                min-height: 250px;
            }

            .voice-trigger-button {
                width: 180px;
                height: 180px;
            }

            .trigger-core {
                width: 130px;
                height: 130px;
            }

            .trigger-icon {
                font-size: 2rem;
            }

            .trigger-text {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Left Side - Custom Voice Trigger Button -->
        <div class="left-widget">
            <!-- Custom Voice Trigger Button -->
            <div class="voice-trigger-container">
                <div class="voice-trigger-button" id="voiceTrigger">
                    <div class="pulse-ring"></div>
                    <div class="pulse-ring pulse-ring-2"></div>
                    <div class="pulse-ring pulse-ring-3"></div>
                    <div class="trigger-core">
                        <div class="trigger-icon">üé§</div>
                        <div class="trigger-text">Tap to Talk</div>
                    </div>
                    <div class="voice-visualizer">
                        <div class="visualizer-bar"></div>
                        <div class="visualizer-bar"></div>
                        <div class="visualizer-bar"></div>
                        <div class="visualizer-bar"></div>
                        <div class="visualizer-bar"></div>
                    </div>
                </div>
                <div class="voice-status" id="voiceStatus">Ready to chat with Nani</div>
            </div>
        </div>

        <!-- Right Side - Space for Image Widget -->
        <div class="right-side">
            <!-- Image display component will appear here -->
        </div>
    </div>

    <!-- Connection Status Badge (moved to bottom left) -->
    <div class="connection-status" id="connectionBadge">üîÑ Connecting...</div>

    <!-- Custom Voice Trigger Button (No external dependencies needed) -->

    <!-- Socket.IO Client Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <!-- Image Display Component -->
    <script src="{{ url_for('static', filename='js/image_display_component.js') }}"></script>

    <script>
        // WebSocket and audio streaming variables
        let socket;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let currentTopic = null;
        let isConnected = false;
        let conversationActive = false;
        let useElevenLabs = false;
        let audioStream;
        let audioContext;
        let audioBuffer = [];

        // DOM elements
        let voiceTrigger, voiceStatus, connectionBadge;
        let isListening = false;
        let currentState = 'idle'; // idle, listening, processing, speaking

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing AI Tutor with Custom Voice Trigger');

            // Initialize DOM elements
            initializeDOMElements();

            // Setup WebSocket connection
            initializeWebSocket();

            // Setup audio recording
            initializeAudioRecording();

            // Setup voice trigger button
            setupVoiceTrigger();

            // Auto-start conversation for simplified flow
            setTimeout(() => {
                if (socket && isConnected) {
                    socket.emit('start_conversation', { topic: 'general' });
                }
            }, 2000);
        });

        function initializeDOMElements() {
            voiceTrigger = document.getElementById('voiceTrigger');
            voiceStatus = document.getElementById('voiceStatus');
            connectionBadge = document.getElementById('connectionBadge');

            console.log('üìã DOM elements initialized');
        }

        function setupVoiceTrigger() {
            if (!voiceTrigger) return;

            // Click/Touch event for voice trigger
            voiceTrigger.addEventListener('click', handleVoiceTrigger);
            voiceTrigger.addEventListener('touchstart', handleVoiceTrigger);

            // Prevent default touch behaviors
            voiceTrigger.addEventListener('touchstart', (e) => e.preventDefault());
            voiceTrigger.addEventListener('touchend', (e) => e.preventDefault());

            console.log('üé§ Voice trigger button initialized');
        }

        function handleVoiceTrigger() {
            if (!conversationActive) {
                updateVoiceStatus('Please wait, starting conversation...');
                return;
            }

            if (currentState === 'idle') {
                startListening();
            } else if (currentState === 'listening') {
                stopListening();
            }
        }

        function startListening() {
            if (!mediaRecorder || mediaRecorder.state !== 'inactive') return;

            currentState = 'listening';
            isListening = true;

            // Update UI
            voiceTrigger.classList.add('active', 'listening');
            updateVoiceStatus('Listening... Speak now!');

            // Start recording
            try {
                mediaRecorder.start(100); // 100ms chunks
                console.log('üé§ Started listening');
            } catch (error) {
                console.error('Error starting recording:', error);
                stopListening();
            }
        }

        function stopListening() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') return;

            currentState = 'processing';
            isListening = false;

            // Update UI
            voiceTrigger.classList.remove('listening');
            voiceTrigger.classList.add('processing');
            updateVoiceStatus('Processing... Please wait');

            // Stop recording
            try {
                mediaRecorder.stop();
                console.log('üõë Stopped listening');
            } catch (error) {
                console.error('Error stopping recording:', error);
            }
        }

        function updateVoiceStatus(message) {
            if (voiceStatus) {
                voiceStatus.textContent = message;
            }
        }

        function setVoiceTriggerState(state, message) {
            currentState = state;

            // Reset all classes
            voiceTrigger.classList.remove('active', 'listening', 'processing', 'speaking');

            switch(state) {
                case 'idle':
                    updateVoiceStatus(message || 'Ready to chat with Nani');
                    break;
                case 'listening':
                    voiceTrigger.classList.add('active', 'listening');
                    updateVoiceStatus(message || 'Listening... Speak now!');
                    break;
                case 'processing':
                    voiceTrigger.classList.add('active', 'processing');
                    updateVoiceStatus(message || 'Processing your message...');
                    break;
                case 'speaking':
                    voiceTrigger.classList.add('active', 'speaking');
                    updateVoiceStatus(message || 'Nani is speaking...');
                    break;
            }
        }

        function initializeWebSocket() {
            console.log('üîå Connecting to WebSocket server...');
            socket = io();

            // Connection events
            socket.on('connect', () => {
                console.log('‚úÖ Connected to server');
                isConnected = true;
                addStatusMessage('system', 'üîó Connected to server - ready for conversation!');
                updateConnectionStatus('connected');
            });

            socket.on('disconnect', () => {
                console.log('‚ùå Disconnected from server');
                isConnected = false;
                conversationActive = false;
                addStatusMessage('system', 'üîå Disconnected from server - trying to reconnect...');
                updateConnectionStatus('disconnected');
                setCharacterState('');
            });

            socket.on('reconnect', () => {
                console.log('üîÑ Reconnected to server');
                addStatusMessage('system', '‚úÖ Reconnected to server!');
                updateConnectionStatus('connected');
            });

            // ElevenLabs-specific events
            socket.on('conversation_started', (data) => {
                console.log('üéØ Conversation started:', data);
                conversationActive = data.success;
                if (data.success) {
                    useElevenLabs = true;
                    addStatusMessage('system', 'üéôÔ∏è Conversation started! Nani is ready...');
                    setVoiceTriggerState('idle', 'Tap to talk with Nani');
                } else {
                    addStatusMessage('system', `‚ùå Failed to start conversation: ${data.error}`);
                    setVoiceTriggerState('idle', 'Failed to start - please refresh');
                }
            });

            socket.on('conversation_ended', (data) => {
                console.log('üõë Conversation ended:', data);
                conversationActive = false;
                addStatusMessage('system', 'üëã Conversation ended. Restarting...');
                setVoiceTriggerState('idle', 'Restarting conversation...');
                // Auto-restart conversation
                setTimeout(() => {
                    if (socket && isConnected) {
                        socket.emit('start_conversation', { topic: 'general' });
                    }
                }, 3000);
            });

            socket.on('agent_response', (data) => {
                console.log('ü§ñ Agent response:', data.response);
                addStatusMessage('ai', data.response);
                setVoiceTriggerState('speaking', 'Nani is speaking...');

                // Auto-return to idle after response (simulating speech duration)
                setTimeout(() => {
                    if (currentState === 'speaking') {
                        setVoiceTriggerState('idle', 'Tap to talk with Nani');
                    }
                }, 3000);

                // call create_image api to get the image url and then pass it in imageDisplayComponent
                // fetch('/create_image', {
                //     method: 'POST',
                //     headers: {
                //         'Content-Type': 'application/json',
                //     },
                //     body: JSON.stringify({ response: data.response })
                // })
                // .then(response => response.json())
                // .then(dataFromCreateImage => {
                //     console.log('üñºÔ∏è Image URL:', dataFromCreateImage.image_url);
                //     if (window.imageDisplayComponent) {
                //         window.imageDisplayComponent.displayImageForResponse(dataFromCreateImage, dataFromCreateImage.image_url);
                //     }
                // })
                // .catch(error => {
                //     console.error('Error generating image:', error);
                // });
            });

            socket.on('user_transcript', (data) => {
                console.log('üé§ User transcript:', data.transcript);
                addStatusMessage('user', data.transcript);
                setVoiceTriggerState('processing', 'Processing your message...');
            });

            socket.on('agent_response_correction', (data) => {
                console.log('üõ†Ô∏è Agent correction:', data);
                addStatusMessage('system', `Correction: ${data.original} ‚Üí ${data.corrected}`);
            });

            socket.on('latency_measurement', (data) => {
                console.log('‚ö° Latency:', data.latency + 'ms');
            });

            socket.on('session_ended', (data) => {
                console.log('üîö Session ended:', data.conversation_id);
                addStatusMessage('system', `Session completed. ID: ${data.conversation_id}`);
                conversationActive = false;
                setCharacterState('');
            });

            socket.on('error', (data) => {
                console.error('‚ùå Socket error:', data);
                addStatusMessage('system', `Error: ${data.error}`);
                setCharacterState('');
            });

            socket.on('status_update', (data) => {
                console.log('üìä Status update:', data);
                conversationActive = data.session_active;
                currentTopic = data.current_topic;
            });
        }

        function initializeAudioRecording() {
            console.log('üéôÔ∏è Initializing audio recording...');

            // Request microphone permission
            navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    sampleRate: 16000
                }
            })
            .then(stream => {
                audioStream = stream;

                // Initialize MediaRecorder for streaming
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                // Handle data available for real-time streaming
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0 && conversationActive && isListening) {
                        // Convert to base64 and stream immediately for ElevenLabs
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const base64Audio = reader.result.split(',')[1];
                            streamAudioChunk(base64Audio);
                        };
                        reader.readAsDataURL(event.data);
                    }
                };

                // Handle recording stop
                mediaRecorder.onstop = () => {
                    console.log('üé§ Recording stopped');
                    // Reset to idle state after a short delay if no response comes
                    setTimeout(() => {
                        if (currentState === 'processing') {
                            setVoiceTriggerState('idle', 'Tap to talk with Nani');
                        }
                    }, 10000); // 10 second timeout
                };

                addStatusMessage('system', 'üé§ Microphone access granted! Ready to chat.');

                // Auto-start recording when conversation is active
                startContinuousRecording();
            })
            .catch(err => {
                addStatusMessage('system', '‚ùå Microphone access denied. Please allow microphone access to use the voice assistant.');
                console.error('Error accessing microphone:', err);
            });
        }

        function startContinuousRecording() {
            // Recording is now manual via trigger button
            console.log('üéôÔ∏è Recording ready - use trigger button to start/stop');
        }

        function updateConnectionStatus(status) {
            switch(status) {
                case 'connected':
                    connectionBadge.innerHTML = 'üü¢ Connected';
                    connectionBadge.style.background = 'linear-gradient(135deg, #4CAF50, #81C784)';
                    break;
                case 'disconnected':
                    connectionBadge.innerHTML = 'üî¥ Disconnected';
                    connectionBadge.style.background = 'linear-gradient(135deg, #F44336, #E57373)';
                    break;
                case 'connecting':
                    connectionBadge.innerHTML = 'üü° Connecting...';
                    connectionBadge.style.background = 'linear-gradient(135deg, #FF9800, #FFB74D)';
                    break;
            }
        }

        function addStatusMessage(type, message) {
            // Status display area removed, just log to console
            let label = '';
            switch(type) {
                case 'user': label = 'You:'; break;
                case 'ai': label = 'Nani:'; break;
                case 'system': label = 'System:'; break;
            }
            console.log(`${label} ${message}`);
        }

        function streamAudioChunk(base64Audio) {
            if (socket && isConnected && conversationActive) {
                socket.emit('audio_chunk', { audio: base64Audio });
            }
        }
    </script>
</body>
</html>
